# Go REST API с аутентификацией и авторизацией

REST API сервис на Go с системой аутентификации и авторизации, использующий:
- GORM для работы с базой данных PostgreSQL
- JWT для безопасной аутентификации пользователей
- Систему ролей для контроля доступа
- Миграции для управления схемой базы данных
- Docker и Docker Compose для удобного развертывания

## Структура проекта

```
go-rest-api/
│
├── cmd/
│   └── api/
│       └── main.go          # Точка входа в приложение
│
├── internal/
│   ├── config/
│   │   └── config.go        # Конфигурация приложения
│   │
│   ├── models/
│   │   └── user.go          # Модели данных (User)
│   │
│   ├── database/
│   │   └── db.go            # Инициализация и управление БД
│   │
│   ├── handlers/
│   │   ├── user_handler.go  # Обработчики для пользователей
│   │   └── auth_handler.go  # Обработчики аутентификации
│   │
│   ├── middleware/
│   │   └── jwt.go           # Middleware для JWT аутентификации и авторизации
│   │
│   ├── migrations/
│   │   ├── migrations.go    # Основной код системы миграций
│   │   ├── 001_create_users_table.go # Создание таблицы пользователей
│   │   └── 002_add_role_to_users.go  # Добавление поля роли
│   │
│   └── router/
│       └── router.go        # Настройка маршрутов API
│
├── .env                     # Переменные окружения
│
├── go.mod                   # Файл модуля Go
├── go.sum                   # Зависимости Go
│
├── Dockerfile               # Конфигурация Docker
│
├── docker-compose.yml       # Конфигурация Docker Compose
│
└── README.md                # Документация
```

## Основные функции

### 1. Аутентификация
- Регистрация новых пользователей ✓
- Вход существующих пользователей с получением JWT-токена ✓
- Защита маршрутов с проверкой токена ✓

### 2. Авторизация
- Система ролей (пользователь/администратор) ✓
- Контроль доступа к ресурсам на основе ролей ✓
- Проверка владения ресурсами ✓

### 3. Управление пользователями
- CRUD операции (создание, чтение, обновление, удаление) ✓
- Хеширование паролей для безопасного хранения ✓
- Проверка уникальности email ✓

### 4. Миграции базы данных
- Автоматическое создание таблиц и полей ✓
- Отслеживание версий схемы БД ✓
- Транзакционное выполнение миграций ✓

## Настройка и запуск

### Необходимые зависимости
- Go 1.16+
- Docker и Docker Compose (для контейнеризации)
- PostgreSQL (или через Docker)

### Запуск с помощью Docker Compose

1. Клонируйте репозиторий
2. Создайте файл `.env` на основе примера и заполните необходимые переменные
3. Выполните команду:

```bash
docker-compose up -d
```

Сервер API будет доступен по адресу `http://localhost:8080`

### Локальный запуск для разработки

1. Установите зависимости:
```bash
go mod download
```

2. Запустите PostgreSQL:
```bash
docker run -d -p 5432:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=postgres postgres:14-alpine
```

3. Создайте файл `.env` с настройками:
```
DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres
PORT=8080
JWT_SECRET=ваш_секретный_ключ_для_jwt
```

4. Запустите приложение:
```bash
go run cmd/api/main.go
```

## API Endpoints

### Аутентификация

- `POST /api/auth/register` - Регистрация нового пользователя
- `POST /api/auth/login` - Вход пользователя (получение JWT токена)

### Пользователи (защищенные маршруты)

- `GET /api/users` - Получить список всех пользователей (только для админов)
- `GET /api/users/:id` - Получить пользователя по ID (пользователь может получить только свои данные)
- `POST /api/users` - Создать нового пользователя (только для админов)
- `PUT /api/users/:id` - Обновить пользователя (только админ или владелец)
- `DELETE /api/users/:id` - Удалить пользователя (только для админов)

## Примеры запросов

### Регистрация пользователя
```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Иван Петров","email":"ivan@example.com","password":"секретный_пароль"}'
```

### Вход пользователя
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"ivan@example.com","password":"секретный_пароль"}'
```

### Получение данных пользователя (с JWT токеном)
```bash
curl -X GET http://localhost:8080/api/users/1 \
  -H "Authorization: Bearer полученный_jwt_токен"
```

## Система ролей

В приложении реализованы две роли:
- **user** - стандартная роль для всех новых пользователей
- **admin** - роль с повышенными привилегиями

Администратор имеет полный доступ ко всем маршрутам и может управлять всеми пользователями.
Обычные пользователи могут просматривать и редактировать только свои данные.

## Безопасность

- Пароли хранятся в хешированном виде с использованием bcrypt
- Аутентификация происходит с использованием JWT токенов
- Контроль доступа реализован через middleware
- Проверка владельца ресурса для обычных пользователей