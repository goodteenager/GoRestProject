# Go REST API с системой аутентификации и авторизации

REST API сервис на Go с расширенной системой ролей и авторизации, использующий:
- GORM для работы с базой данных PostgreSQL
- JWT для безопасной аутентификации пользователей
- Систему ролей (user, moderator, admin) для контроля доступа
- Миграции для управления схемой базы данных
- Docker и Docker Compose для удобного развертывания

## Структура проекта

```
go-rest-api/
│
├── cmd/
│   └── api/
│       └── main.go          # Точка входа в приложение
│
├── internal/
│   ├── config/
│   │   └── config.go        # Конфигурация приложения
│   │
│   ├── models/
│   │   └── user.go          # Модели данных (User)
│   │
│   ├── database/
│   │   └── db.go            # Инициализация и управление БД
│   │
│   ├── handlers/
│   │   ├── user_handler.go  # Обработчики для пользователей
│   │   └── auth_handler.go  # Обработчики аутентификации
│   │
│   ├── middleware/
│   │   ├── jwt.go           # Middleware для JWT аутентификации
│   │   └── role.go          # Middleware для управления ролями
│   │
│   ├── migrations/
│   │   ├── migrations.go    # Основной код системы миграций
│   │   ├── 001_create_users_table.go # Создание таблицы пользователей
│   │   └── 002_add_role_to_users.go  # Добавление поля роли
│   │
│   └── router/
│       └── router.go        # Настройка маршрутов API
│
├── .env                     # Переменные окружения
│
├── go.mod                   # Файл модуля Go
├── go.sum                   # Зависимости Go
│
├── Dockerfile               # Конфигурация Docker
│
├── docker-compose.yml       # Конфигурация Docker Compose
│
└── README.md                # Документация
```

## Основные функции

### 1. Аутентификация
- Регистрация новых пользователей
- Вход существующих пользователей с получением JWT-токена
- Защита маршрутов с проверкой токена

### 2. Авторизация
- Расширенная система ролей (пользователь/модератор/администратор)
- Контроль доступа к ресурсам на основе ролей
- Проверка владения ресурсами

### 3. Управление пользователями
- CRUD операции с разграничением прав
- Хеширование паролей для безопасного хранения
- Проверка уникальности email

### 4. Миграции базы данных
- Автоматическое создание таблиц и полей
- Отслеживание версий схемы БД
- Транзакционное выполнение миграций

## Настройка и запуск

### Необходимые зависимости
- Go 1.16+
- Docker и Docker Compose (для контейнеризации)
- PostgreSQL (или через Docker)

### Запуск с помощью Docker Compose

1. Клонируйте репозиторий
2. Создайте файл `.env` на основе примера и заполните необходимые переменные
3. Выполните команду:

```bash
docker-compose up -d
```

Сервер API будет доступен по адресу `http://localhost:8080`

### Локальный запуск для разработки

1. Установите зависимости:
```bash
go mod download
```

2. Запустите PostgreSQL:
```bash
docker run -d -p 5432:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=postgres postgres:14-alpine
```

3. Создайте файл `.env` с настройками:
```
DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres
PORT=8080
JWT_SECRET=ваш_секретный_ключ_для_jwt
```

4. Запустите приложение:
```bash
go run cmd/api/main.go
```

## Тестирование API с помощью Postman

Ниже приведены примеры запросов для тестирования API с помощью Postman. Создайте новую коллекцию и добавьте следующие запросы:

### 1. Регистрация нового пользователя

**Запрос:**
- Метод: POST
- URL: http://localhost:8080/api/auth/register
- Body (JSON):
```json
{
    "name": "Обычный Пользователь",
    "email": "user@example.com",
    "password": "password123",
    "role": "user"
}
```

**Ответ:**
```json
{
    "token": "ваш_jwt_токен",
    "user": {
        "id": 1,
        "created_at": "2025-04-21T10:00:00Z",
        "updated_at": "2025-04-21T10:00:00Z",
        "name": "Обычный Пользователь",
        "email": "user@example.com",
        "role": "user"
    }
}
```

### 2. Регистрация администратора

**Запрос:**
- Метод: POST
- URL: http://localhost:8080/api/auth/register
- Body (JSON):
```json
{
    "name": "Администратор",
    "email": "admin@example.com",
    "password": "admin123",
    "role": "admin"
}
```

### 3. Регистрация модератора

**Запрос:**
- Метод: POST
- URL: http://localhost:8080/api/auth/register
- Body (JSON):
```json
{
    "name": "Модератор",
    "email": "moderator@example.com",
    "password": "moderator123",
    "role": "moderator"
}
```

### 4. Вход пользователя (получение токена)

**Запрос:**
- Метод: POST
- URL: http://localhost:8080/api/auth/login
- Body (JSON):
```json
{
    "email": "user@example.com",
    "password": "password123"
}
```

**Ответ:**
```json
{
    "token": "ваш_jwt_токен",
    "user": {
        "id": 1,
        "created_at": "2025-04-21T10:00:00Z",
        "updated_at": "2025-04-21T10:00:00Z",
        "name": "Обычный Пользователь",
        "email": "user@example.com",
        "role": "user"
    }
}
```

### 5. Получение данных пользователя

**Запрос:**
- Метод: GET
- URL: http://localhost:8080/api/users/1
- Headers:
    - Authorization: Bearer ваш_jwt_токен_пользователя

**Ответ:**
```json
{
    "id": 1,
    "created_at": "2025-04-21T10:00:00Z",
    "updated_at": "2025-04-21T10:00:00Z",
    "name": "Обычный Пользователь",
    "email": "user@example.com",
    "role": "user"
}
```

**Проверка ограничений доступа:** Пользователь может получить только свои данные. Попробуйте получить данные другого пользователя с токеном обычного пользователя, чтобы проверить ограничение.

### 6. Получение списка всех пользователей (только модератор или администратор)

**Запрос:**
- Метод: GET
- URL: http://localhost:8080/api/users
- Headers:
    - Authorization: Bearer ваш_jwt_токен_модератора_или_админа

**Ответ:**
```json
[
    {
        "id": 1,
        "created_at": "2025-04-21T10:00:00Z",
        "updated_at": "2025-04-21T10:00:00Z",
        "name": "Обычный Пользователь",
        "email": "user@example.com",
        "role": "user"
    },
    {
        "id": 2,
        "created_at": "2025-04-21T10:05:00Z",
        "updated_at": "2025-04-21T10:05:00Z",
        "name": "Администратор",
        "email": "admin@example.com",
        "role": "admin"
    },
    {
        "id": 3,
        "created_at": "2025-04-21T10:10:00Z",
        "updated_at": "2025-04-21T10:10:00Z",
        "name": "Модератор",
        "email": "moderator@example.com",
        "role": "moderator"
    }
]
```

**Проверка ограничений доступа:** Попробуйте выполнить этот запрос с токеном обычного пользователя, чтобы убедиться, что доступ запрещен.

### 7. Обновление своих данных (пользователь)

**Запрос:**
- Метод: PUT
- URL: http://localhost:8080/api/users/1
- Headers:
    - Authorization: Bearer ваш_jwt_токен_пользователя
- Body (JSON):
```json
{
    "name": "Обновленное Имя",
    "email": "updated@example.com",
    "password": "newpassword123"
}
```

**Ответ:**
```json
{
    "id": 1,
    "created_at": "2025-04-21T10:00:00Z",
    "updated_at": "2025-04-21T11:00:00Z",
    "name": "Обновленное Имя",
    "email": "updated@example.com",
    "role": "user"
}
```

**Проверка ограничений доступа:** Попробуйте обновить роль пользователя или данные другого пользователя, чтобы проверить ограничения.

### 8. Обновление пользователя администратором

**Запрос:**
- Метод: PUT
- URL: http://localhost:8080/api/users/1/admin
- Headers:
    - Authorization: Bearer ваш_jwt_токен_администратора
- Body (JSON):
```json
{
    "name": "Имя от Админа",
    "role": "moderator"
}
```

**Ответ:**
```json
{
    "id": 1,
    "created_at": "2025-04-21T10:00:00Z",
    "updated_at": "2025-04-21T12:00:00Z",
    "name": "Имя от Админа",
    "email": "updated@example.com",
    "role": "moderator"
}
```

### 9. Создание нового пользователя администратором

**Запрос:**
- Метод: POST
- URL: http://localhost:8080/api/users
- Headers:
    - Authorization: Bearer ваш_jwt_токен_администратора
- Body (JSON):
```json
{
    "name": "Новый Пользователь",
    "email": "new@example.com",
    "password": "newpass123",
    "role": "user"
}
```

**Ответ:**
```json
{
    "id": 4,
    "created_at": "2025-04-21T13:00:00Z",
    "updated_at": "2025-04-21T13:00:00Z",
    "name": "Новый Пользователь",
    "email": "new@example.com",
    "role": "user"
}
```

**Проверка ограничений доступа:** Попробуйте выполнить этот запрос с токеном обычного пользователя или модератора, чтобы убедиться, что доступ запрещен.

### 10. Удаление пользователя (только администратор)

**Запрос:**
- Метод: DELETE
- URL: http://localhost:8080/api/users/4
- Headers:
    - Authorization: Bearer ваш_jwt_токен_администратора

**Ответ:**
```json
{
    "message": "User deleted successfully"
}
```

**Проверка ограничений доступа:** Попробуйте выполнить этот запрос с токеном обычного пользователя или модератора, чтобы убедиться, что доступ запрещен.

## Советы по тестированию

1. **Управление токенами:** В Postman создайте переменные окружения для хранения разных JWT токенов (user_token, admin_token, moderator_token). Это упростит тестирование.

2. **Автоматический захват токена:** Настройте тесты в Postman для автоматического сохранения токена из ответа:
```javascript
// В тесте запроса логина
var jsonData = JSON.parse(responseBody);
pm.environment.set("user_token", jsonData.token);
```

3. **Проверка ролей:** Систематически проверяйте доступ каждой роли к различным конечным точкам API, чтобы убедиться, что ограничения доступа работают правильно.

4. **Тестирование граничных случаев:** Попробуйте недопустимые значения ролей, неправильные форматы данных, дублирующиеся email и т.д., чтобы проверить обработку ошибок.

5. **Проверка обновлений:** Убедитесь, что пользователи могут обновлять только свои собственные данные, а изменение ролей доступно только администраторам.
